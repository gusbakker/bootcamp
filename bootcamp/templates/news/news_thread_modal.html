{% load i18n static %}
{% load thumbnail %}

<div class="modal fade" id="newsThreadModal" tabindex="-1" aria-labelledby="newsThreadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-dark">
                <h5 class="modal-title fw-bold text-light" id="newsThreadModalLabel">{% trans "Comments" %}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Original Post -->
            <div class="modal-body pb-0">
                <ul class="stream p-0 m-0" id="newsContent"></ul>
            </div>

            <!-- Comments Area -->
            <div class="modal-body pt-0">
                <hr class="border-dark">
                <h6 class="fw-semibold mb-3 text-light">{% trans "Replies" %}</h6>
                <ul class="stream p-0 m-0" id="threadContent"></ul>
            </div>

            <!-- Reply Form -->
            <div class="modal-footer border-top border-dark">
                <form id="replyNewsForm" role="form" method="post" action="#" onsubmit="return false" class="w-100">
                    {% csrf_token %}
                    <input type="hidden" name="parent" value="">
                    <div class="input-group">
                        <textarea id="replyInput" name="reply" rows="1" class="form-control bg-dark text-light border-dark"
                                maxlength="280" placeholder="{% trans 'Write a comment...' %}"></textarea>
                        <button type="button" id="replyNews" class="btn btn-primary">
                            <i class="fa-regular fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-end mt-1">
                        <small id="replyCounter" class="text-muted">280</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Character counter for reply
    const replyInput = document.getElementById('replyInput');
    const replyCounter = document.getElementById('replyCounter');

    replyInput.addEventListener('keyup', function() {
      const charCount = this.value.length;
      replyCounter.textContent = 280 - charCount;

      if (charCount > 240) {
        replyCounter.classList.add('text-danger');
      } else {
        replyCounter.classList.remove('text-danger');
      }
    });

    // Auto-expand textarea
    replyInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Light/Dark mode adaptation
    function updateModalTheme() {
      const isLightMode = document.documentElement.getAttribute('data-theme') === 'light';
      const modal = document.querySelector('#newsThreadModal .modal-content');
      const inputs = document.querySelectorAll('#newsThreadModal .form-control');
      const modalTitle = document.querySelector('#newsThreadModal .modal-title');
      const modalSubtitle = document.querySelector('#newsThreadModal h6.text-light');
      const borders = document.querySelectorAll('#newsThreadModal .border-dark');
      const closeBtn = document.querySelector('#newsThreadModal .btn-close');

      if (isLightMode) {
        modal.classList.remove('bg-dark');
        modal.classList.add('bg-white');

        inputs.forEach(input => {
          input.classList.remove('bg-dark', 'text-light', 'border-dark');
          input.classList.add('bg-white', 'text-dark', 'border-light');
        });

        modalTitle.classList.remove('text-light');
        modalTitle.classList.add('text-dark');

        if (modalSubtitle) {
          modalSubtitle.classList.remove('text-light');
          modalSubtitle.classList.add('text-dark');
        }

        borders.forEach(border => {
          border.classList.remove('border-dark');
          border.classList.add('border-light');
        });

        closeBtn.classList.remove('btn-close-white');
      } else {
        modal.classList.add('bg-dark');
        modal.classList.remove('bg-white');

        inputs.forEach(input => {
          input.classList.add('bg-dark', 'text-light', 'border-dark');
          input.classList.remove('bg-white', 'text-dark', 'border-light');
        });

        modalTitle.classList.add('text-light');
        modalTitle.classList.remove('text-dark');

        if (modalSubtitle) {
          modalSubtitle.classList.add('text-light');
          modalSubtitle.classList.remove('text-dark');
        }

        borders.forEach(border => {
          border.classList.add('border-dark');
          border.classList.remove('border-light');
        });

        closeBtn.classList.add('btn-close-white');
      }
    }

    // Run on initial load and modal show
    $('#newsThreadModal').on('shown.bs.modal', updateModalTheme);

    // Listen for theme changes
    const darkSwitch = document.getElementById('darkSwitch');
    if (darkSwitch) {
      darkSwitch.addEventListener('change', function() {
        setTimeout(updateModalTheme, 50);
      });
    }
  });
</script>