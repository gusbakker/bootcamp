{% load i18n %}

<div class="modal fade" id="newsFormModal" tabindex="-1" aria-labelledby="newsFormModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark">
      <div class="modal-header border-bottom border-dark">
        <h5 class="modal-title fw-bold text-light" id="newsFormModalTitle">{% trans "Share something new!" %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form enctype="multipart/form-data" id="postNewsForm" role="form" method="post" action="">
          {% csrf_token %}
          <div class="mb-3">
            <textarea id="newsInput" name="post" rows="3" class="form-control bg-dark text-light border-dark" maxlength="280" placeholder="{% trans 'What\'s on your mind?' %}"></textarea>
            <div class="d-flex justify-content-end mt-2">
              <span id="newsCounter" class="text-muted small">280</span>
            </div>

            <!-- Upload image input-->
            <div class="mt-3">
              <div class="input-group">
                <input id="imageInput" type="file" name="image" class="form-control bg-dark text-light border-dark" accept="image/*">
                <label class="input-group-text bg-dark text-light border-dark" for="imageInput">
                  <i class="fa-regular fa-image me-2"></i>
                  {% trans 'Image' %}
                </label>
              </div>
            </div>

            <!-- Uploaded image preview -->
            <div class="image-area mt-3 position-relative">
              <img id="imageResult" src="#" alt="" class="img-fluid rounded shadow-sm mx-auto d-block" style="max-height: 250px; display: none;">
              <button type="button" id="removeImage" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" style="display: none;">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top border-dark">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
        <button type="button" id="postNews" class="btn btn-primary">
          <i class="fa-regular fa-paper-plane me-2"></i>{% trans 'Post' %}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Image preview
    const imageInput = document.getElementById('imageInput');
    const imageResult = document.getElementById('imageResult');
    const removeImage = document.getElementById('removeImage');

    imageInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();

        reader.onload = function(e) {
          imageResult.src = e.target.result;
          imageResult.style.display = 'block';
          removeImage.style.display = 'block';
        }

        reader.readAsDataURL(this.files[0]);
      }
    });

    removeImage.addEventListener('click', function() {
      imageInput.value = '';
      imageResult.src = '';
      imageResult.style.display = 'none';
      this.style.display = 'none';
    });

    // Character counter
    const newsInput = document.getElementById('newsInput');
    const newsCounter = document.getElementById('newsCounter');

    newsInput.addEventListener('keyup', function() {
      const charCount = this.value.length;
      newsCounter.textContent = 280 - charCount;

      if (charCount > 240) {
        newsCounter.classList.add('text-danger');
      } else {
        newsCounter.classList.remove('text-danger');
      }
    });

    // Light/Dark mode adaptation
    function updateModalTheme() {
      const isLightMode = document.documentElement.getAttribute('data-theme') === 'light';
      const modal = document.querySelector('#newsFormModal .modal-content');
      const inputs = document.querySelectorAll('#newsFormModal .form-control, #newsFormModal .input-group-text');
      const modalTitle = document.querySelector('#newsFormModal .modal-title');
      const borders = document.querySelectorAll('#newsFormModal .border-dark');
      const closeBtn = document.querySelector('#newsFormModal .btn-close');

      if (isLightMode) {
        modal.classList.remove('bg-dark');
        modal.classList.add('bg-white');

        inputs.forEach(input => {
          input.classList.remove('bg-dark', 'text-light', 'border-dark');
          input.classList.add('bg-white', 'text-dark', 'border-light');
        });

        modalTitle.classList.remove('text-light');
        modalTitle.classList.add('text-dark');

        borders.forEach(border => {
          border.classList.remove('border-dark');
          border.classList.add('border-light');
        });

        closeBtn.classList.remove('btn-close-white');
      } else {
        modal.classList.add('bg-dark');
        modal.classList.remove('bg-white');

        inputs.forEach(input => {
          input.classList.add('bg-dark', 'text-light', 'border-dark');
          input.classList.remove('bg-white', 'text-dark', 'border-light');
        });

        modalTitle.classList.add('text-light');
        modalTitle.classList.remove('text-dark');

        borders.forEach(border => {
          border.classList.add('border-dark');
          border.classList.remove('border-light');
        });

        closeBtn.classList.add('btn-close-white');
      }
    }

    // Run on initial load
    updateModalTheme();

    // Listen for theme changes
    const darkSwitch = document.getElementById('darkSwitch');
    if (darkSwitch) {
      darkSwitch.addEventListener('change', function() {
        setTimeout(updateModalTheme, 50);
      });
    }
  });
</script>