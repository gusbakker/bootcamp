{% load i18n %}

<div class="modal fade" id="newsFormModal" tabindex="-1" aria-labelledby="newsFormModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title fw-bold" id="newsFormModalTitle">{% trans "Share something new!" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form enctype="multipart/form-data" id="postNewsForm" role="form" method="post" action="">
          {% csrf_token %}
          <div class="mb-3">
            <textarea id="newsInput" name="post" rows="3" class="form-control" maxlength="280" placeholder="{% trans 'What\'s on your mind?' %}"></textarea>
            <div class="d-flex justify-content-end mt-2">
              <span id="newsCounter" class="text-muted small">280</span>
            </div>

            <!-- Upload image input-->
            <div class="mt-3">
              <div class="input-group">
                <input id="imageInput" type="file" name="image" class="form-control" accept="image/*">
                <label class="input-group-text" for="imageInput">
                  <i class="fa-regular fa-image me-2"></i>
                  {% trans 'Image' %}
                </label>
              </div>
            </div>

            <!-- Uploaded image preview -->
            <div class="image-area mt-3 position-relative">
              <img id="imageResult" src="#" alt="" class="img-fluid rounded shadow-sm mx-auto d-block" style="max-height: 250px; display: none;">
              <button type="button" id="removeImage" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" style="display: none;">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
        <button type="button" id="postNews" class="btn btn-primary">
          <i class="fa-regular fa-paper-plane me-2"></i>{% trans 'Post' %}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Image preview
    const imageInput = document.getElementById('imageInput');
    const imageResult = document.getElementById('imageResult');
    const removeImage = document.getElementById('removeImage');

    imageInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();

        reader.onload = function(e) {
          imageResult.src = e.target.result;
          imageResult.style.display = 'block';
          removeImage.style.display = 'block';
        }

        reader.readAsDataURL(this.files[0]);
      }
    });

    removeImage.addEventListener('click', function() {
      imageInput.value = '';
      imageResult.src = '';
      imageResult.style.display = 'none';
      this.style.display = 'none';
    });

    // Character counter
    const newsInput = document.getElementById('newsInput');
    const newsCounter = document.getElementById('newsCounter');

    newsInput.addEventListener('keyup', function() {
      const charCount = this.value.length;
      newsCounter.textContent = 280 - charCount;

      if (charCount > 240) {
        newsCounter.classList.add('text-danger');
      } else {
        newsCounter.classList.remove('text-danger');
      }
    });
  });
</script>